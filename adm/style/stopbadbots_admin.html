<!-- INCLUDE overall_header.html -->
<!-- INCLUDECSS @mundophpbb_stopbadbots/stopbadbots.css -->
<link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@400;500;600;700&display=swap" rel="stylesheet">

<div class="stopbadbots-acp">
    <h1>{L_ACP_STOPBADBOTS_SETTINGS}</h1>
    <p>{L_ACP_STOPBADBOTS_SETTINGS_EXPLAIN}</p>
    <p><strong>{L_ACP_STOPBADBOTS_VERSION}: <span class="version-highlight">{STOPBADBOTS_VERSION}</span></strong></p>

    <!-- IF S_ERROR -->
    <div class="errorbox" role="alert">
        <h3>{L_ERROR}</h3>
        <p>{ERROR_MESSAGE}</p>
    </div>
    <!-- ENDIF -->

    <!-- IF S_SUCCESS -->
    <div class="successbox" role="alert">
        <h3>{L_SUCCESS}</h3>
        <p>{SUCCESS_MESSAGE}</p>
    </div>
    <!-- ENDIF -->

    <form id="stopbadbots_settings" method="post" action="{U_ACTION}">
        <fieldset>
            <legend>{L_ACP_STOPBADBOTS_SETTINGS}</legend>

            <dl>
                <dt>
                    <label for="stopbadbots_enabled">{L_ACP_STOPBADBOTS_ENABLED}:</label>
                    <br /><span id="stopbadbots_enabled_explain">{L_ACP_STOPBADBOTS_ENABLED_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="checkbox" name="stopbadbots_enabled" id="stopbadbots_enabled" value="1" <!-- IF STOPBADBOTS_ENABLED -->checked="checked"<!-- ENDIF --> aria-describedby="stopbadbots_enabled_explain" />
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="stopbadbots_cron_enabled">{L_ACP_STOPBADBOTS_CRON_ENABLED}:</label>
                    <br /><span id="stopbadbots_cron_enabled_explain">{L_ACP_STOPBADBOTS_CRON_ENABLED_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="checkbox" name="stopbadbots_cron_enabled" id="stopbadbots_cron_enabled" value="1" <!-- IF STOPBADBOTS_CRON_ENABLED -->checked="checked"<!-- ENDIF --> aria-describedby="stopbadbots_cron_enabled_explain" />
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="stopbadbots_cron_interval">{L_ACP_STOPBADBOTS_CRON_INTERVAL}:</label>
                    <br /><span id="stopbadbots_cron_interval_explain">{L_ACP_STOPBADBOTS_CRON_INTERVAL_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="number" name="stopbadbots_cron_interval" id="stopbadbots_cron_interval" value="{STOPBADBOTS_CRON_INTERVAL}" min="3600" max="604800" step="3600" class="inputbox" aria-describedby="stopbadbots_cron_interval_explain cron_interval_error" required />
                    <span>{L_SECONDS}</span>
                    <p id="cron_interval_error" class="error">{L_ACP_STOPBADBOTS_CRON_INTERVAL_ERROR}</p>
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="stopbadbots_log_retention_days">{L_ACP_STOPBADBOTS_LOG_RETENTION_DAYS}:</label>
                    <br /><span id="stopbadbots_log_retention_days_explain">{L_ACP_STOPBADBOTS_LOG_RETENTION_DAYS_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="number" name="stopbadbots_log_retention_days" id="stopbadbots_log_retention_days" value="{STOPBADBOTS_LOG_RETENTION_DAYS}" min="1" max="365" step="1" class="inputbox" aria-describedby="stopbadbots_log_retention_days_explain retention_days_error" required />
                    <span>{L_DAYS}</span>
                    <p id="retention_days_error" class="error">{L_ACP_STOPBADBOTS_LOG_RETENTION_DAYS_ERROR}</p>
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="stopbadbots_use_x_forwarded_for">{L_ACP_STOPBADBOTS_USE_X_FORWARDED_FOR}:</label>
                    <br /><span id="stopbadbots_use_x_forwarded_for_explain">{L_ACP_STOPBADBOTS_USE_X_FORWARDED_FOR_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="checkbox" name="stopbadbots_use_x_forwarded_for" id="stopbadbots_use_x_forwarded_for" value="1" <!-- IF STOPBADBOTS_USE_X_FORWARDED_FOR -->checked="checked"<!-- ENDIF --> aria-describedby="stopbadbots_use_x_forwarded_for_explain" />
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="stopbadbots_debug_enabled">{L_ACP_STOPBADBOTS_DEBUG_ENABLED}:</label>
                    <br /><span id="stopbadbots_debug_enabled_explain">{L_ACP_STOPBADBOTS_DEBUG_ENABLED_EXPLAIN}</span>
                </dt>
                <dd>
                    <input type="checkbox" name="stopbadbots_debug_enabled" id="stopbadbots_debug_enabled" value="1" <!-- IF STOPBADBOTS_DEBUG_ENABLED -->checked="checked"<!-- ENDIF --> aria-describedby="stopbadbots_debug_enabled_explain" />
                </dd>
            </dl>

            <dl>
                <dt>
                    <label for="blockStatsChart">{L_ACP_STOPBADBOTS_STATISTICS}:</label>
                    <br /><span id="stopbadbots_statistics_explain">{L_ACP_STOPBADBOTS_STATISTICS_EXPLAIN}</span>
                </dt>
                <dd>
                    <canvas id="blockStatsChart" width="400" height="200" aria-label="{L_ACP_STOPBADBOTS_STATISTICS}"></canvas>
                </dd>
            </dl>

            <div class="submit-buttons">
                <input type="hidden" name="action" value="save_settings" />
                <input type="submit" name="submit" value="{L_S_SUBMIT}" class="button" aria-label="{L_S_SUBMIT}" />
                <input type="reset" value="{L_RESET}" class="button remove" aria-label="{L_RESET}" />
                {S_FORM_TOKEN}
            </div>
        </fieldset>
    </form>

    <fieldset>
        <legend>{L_STATISTICS_AND_CRON}</legend>

        <dl>
            <dt>{L_CRON_LAST_RUN}:</dt>
            <dd>{CRON_LAST_RUN}</dd>
        </dl>

        <dl>
            <dt>{L_DAILY_BLOCKS}:</dt>
            <dd>{DAILY_BLOCKS}</dd>
        </dl>

        <form id="run_cron_form" method="post" action="{U_ACTION}">
            <div class="submit-buttons">
                <input type="hidden" name="action" value="run_cron" />
                <input type="submit" name="submit" value="{L_RUN_CRON}" class="button" onclick="return confirm('{L_CONFIRM_RUN_CRON}');" aria-label="{L_RUN_CRON}" />
                {S_FORM_TOKEN}
            </div>
        </form>
    </fieldset>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Validação do campo cron_interval
    const cronIntervalInput = document.getElementById('stopbadbots_cron_interval');
    const cronIntervalError = document.getElementById('cron_interval_error');
    if (cronIntervalInput) {
        cronIntervalInput.addEventListener('input', function() {
            const value = parseInt(this.value, 10);
            if (isNaN(value) || value < 3600 || value > 604800) {
                cronIntervalError.style.display = 'block';
                this.setCustomValidity('{L_ACP_STOPBADBOTS_CRON_INTERVAL_ERROR}');
            } else {
                cronIntervalError.style.display = 'none';
                this.setCustomValidity('');
            }
        });
    }

    // Validação do campo log_retention_days
    const retentionDaysInput = document.getElementById('stopbadbots_log_retention_days');
    const retentionDaysError = document.getElementById('retention_days_error');
    if (retentionDaysInput) {
        retentionDaysInput.addEventListener('input', function() {
            const value = parseInt(this.value, 10);
            if (isNaN(value) || value < 1 || value > 365) {
                retentionDaysError.style.display = 'block';
                this.setCustomValidity('{L_ACP_STOPBADBOTS_LOG_RETENTION_DAYS_ERROR}');
            } else {
                retentionDaysError.style.display = 'none';
                this.setCustomValidity('');
            }
        });
    }

    // Gráfico de estatísticas
    const ctx = document.getElementById('blockStatsChart')?.getContext('2d');
    if (ctx) {
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['{L_USER_AGENT}', '{L_IP}', '{L_REFERER}'],
                datasets: [{
                    label: '{L_ACP_STOPBADBOTS_DAILY_BLOCKS}',
                    data: [
                        parseInt('{STOPBADBOTS_DAILY_UA_BLOCKS}', 10) || 0,
                        parseInt('{STOPBADBOTS_DAILY_IP_BLOCKS}', 10) || 0,
                        parseInt('{STOPBADBOTS_DAILY_REF_BLOCKS}', 10) || 0
                    ],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)'
                    ],
                    borderColor: [
                        'rgba(75, 192, 192, 1)',
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '{L_ACP_STOPBADBOTS_BLOCKS}'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.raw}`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>

<!-- INCLUDE overall_footer.html -->